<!--  This file is part of the research.fi API service
Copyright 2019 Ministry of Education and Culture, Finland
:author: CSC - IT Center for Science Ltd., Espoo Finland servicedesk@csc.fi
:license: MIT -->

<h1 #srHeader aria-live="polite" class="sr-only"></h1>
<aside>
  <app-search-bar></app-search-bar>
</aside>

<div class="center-content wrapper" style="margin-top: 0">
  <div class="row g-0">
    <app-result-tab
      style="width: 100%"
      class="px-0"
      [allData]="tabValues"
    ></app-result-tab>

    <!-- TODO: Button for navigation to the new publication search -->
    <ng-container *ngIf="tab === 'publications' && betaSearchBannerVisible">
      <div class="row py-3 px-0 ps-lg-3 mt-3 justify-content-between login-snackbar">
        <div class="row col-7 justify-content-start align-content-center">
          <div class="col-auto mx-0 gx-0">
            <fa-icon class="info-icon" icon="info-circle"></fa-icon>
          </div>

          <div class="col-11 align-self-center" i18n="@@logInToCreateProfile">
            TODO: Kokeile uutta julkaisuhakua.
          </div>
        </div>

        <div class="row col-5 pe-lg-0 justify-content-end">
          <div class="col-auto pe-lg-0 py-1">
            <app-primary-action-button
              role="link"
              routerLink='/results/publications2'
              content="Siirry uuteen hakuun"
              i18n-content="@@logIn">
            </app-primary-action-button>
          </div>

          <div class="col-auto align-self-center">
            <div>
              <a
                tabindex="0"
                (click)="hideBetaSearchBanner()"
                href="javascript:void(0)">
                <strong i18n="@@close">Sulje</strong>
              </a>
            </div>
          </div>
        </div>
      </div>
    </ng-container>



    <!-- MyData login in persons tab -->
    <div
      class="row py-3 px-0 ps-lg-3 mt-3 justify-content-between login-snackbar"
      *ngIf="tab === 'persons' && mydataLoginSnackbarVisible">                                                          <!-- REMOVE TODO: Yleistetty logiikka, "tab" muuttuja kertoo valitun -->
      <div class="row col-7 justify-content-start align-content-center">
        <div class="col-auto mx-0 gx-0">
          <fa-icon class="info-icon" icon="info-circle"></fa-icon>
        </div>
        <div class="col-11 align-self-center" i18n="@@logInToCreateProfile">
          Kirjaudu sisään luodaksesi profiilin tai valitaksesi profiilissasi
          näkyviä tietoja.
        </div>
      </div>
      <div class="row col-5 pe-lg-0 justify-content-end">
        <div class="col-auto pe-lg-0 py-1">
          <app-primary-action-button
            role="link"
            (click)="router.navigate(['/mydata'])"
            content="Kirjaudu sisään"
            i18n-content="@@logIn">
          </app-primary-action-button>
        </div>
        <div class="col-auto pe-lg-0 py-1">
          <app-secondary-button
            content="Ohjeet"
            i18n-content="@@instructions"
            (click)="showLoginInfoDialog = true">
          </app-secondary-button>
        </div>
        <div class="col-auto align-self-center">
          <div> <!-- TODO: hideMydataLoginSnackbar is technically wrong, or poorly named -->
          <a
            tabindex="0"
            (click)="hideMydataLoginSnackbar()"
            href="javascript:void(0)">
            <strong i18n="@@close">Sulje</strong>
          </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Left sidebar -->
    <div class="col-lg-4 col-xl-3">
      <!-- Tab label and total count -->
      <div class="row align-items-center justify-content-between">
        <h2
          role="status"
          class="col-auto total"
          *ngIf="selectedTabData ? selectedTabData.label : ''"
        >
          {{ selectedTabData.label }} -
          <span class="total">{{ parsedTotal }}</span>
          <span class="sr-only" i18n="@@resultCount">hakutulosta</span>
        </h2>

        <!-- Mobile page settings -->
        <div class="col-auto px-0" *ngIf="selectedTabData && mobile">
          <app-result-count
            [page]="searchService.pageNumber"
            [pageSize]="searchService.pageSize"
            [total]="dataService.currentTotal | async"
          ></app-result-count>
        </div>
      </div>

      <!-- Skip link -->
      <div
        id="sr-helper"
        class="row skip-links pb-2"
        [ngClass]="showSkipLinks ? 'show' : 'sr-only'"
      >
        <a
          (focus)="showSkipLinks = true"
          #skipToResults
          tabindex="0"
          (click)="changeFocusTarget('main')"
          (blur)="resetFocus(); showSkipLinks = false"
          href="javascript:void(0)"
        >
          <span i18n="@@skipToResults">Hyppää hakutuloksiin</span>
        </a>
      </div>

      <!-- Open visual button -->
      <div
        class="justify-content-center align-items-center d-none d-lg-flex visual-button-container"
        *ngIf="(tab === 'publications' || tab === 'fundings') && !mobile"
      >
        <app-primary-action-button
          [content]="showAsVisual"
          [icon]="faChartBar"
          (click)="openDialog(visualModal)"
        ></app-primary-action-button>
      </div>

      <!-- Filters & sort -->
      <div class="row g-0">
        <!-- Filters -->
        <div class="col">
          <ng-container [ngTemplateOutlet]="filtersTemplate"></ng-container>
        </div>

        <!-- Mobile sort -->
        <aside class="col col-6 ps-2 sort" *ngIf="mobile">
          <app-sort></app-sort>
        </aside>
      </div>
    </div>

    <!-- Main content area -->
    <div class="col-12 col-lg-8 col-xl-9 row main-content px-0 pe-xl-0">

      <!-- Desktop page settings -->
      <div class="row justify-content-end py-3 pe-0" *ngIf="!mobile">
        <div class="col-auto px-0" *ngIf="selectedTabData">
          <app-result-count
            [page]="searchService.pageNumber"
            [pageSize]="searchService.pageSize"
            [total]="dataService.currentTotal | async"
            [focusSelect]="focusMainContent"
          ></app-result-count>
        </div>

        <div class="col-auto text-end d-none d-lg-block ps-4 pe-0">
          <a
            routerLink="/service-info"
            fragment="service-info-2"
            class="theme-link"
          ><strong>
            <ng-container *ngIf="selectedTabData.singular === 'Rahoitushaku'" i18n="@@fundingCallsIncluded">
              Mitä rahoitushakutietoja palvelu sisältää?
            </ng-container>

              <ng-container *ngIf="selectedTabData.singular !== 'Rahoitushaku'" i18n="@@resultInfo1">Mitä</ng-container
              ><span *ngIf="selectedTabData.singular !== 'Rahoitushaku'"> {{ selectedTabData?.singular.toLowerCase() }}</span>
              <ng-container *ngIf="selectedTabData.singular !== 'Rahoitushaku'" i18n="@@resultInfo2"
                >tietoja palvelu sisältää?</ng-container
              >
            </strong>
          </a>
        </div>
      </div>

      <main id="main-content" class="ps-lg-3 pt-lg-0">
        <!-- Active filters list -->
        <div class="row">
          <ng-container *ngIf="page <= 1000; else pageOverflow">
            <div class="col px-0 ps-lg-2">
              <app-funding-call-category-filters
                *ngIf="tab === 'funding-calls' && filterValues"
                [resetFundingCallCategoryFilters]="clearAllFilters"
                [responseData]="filterValues"
                (filterChangeOutput)="setExternalFilters($event)"
              >
              </app-funding-call-category-filters>

              <app-active-filters
                (clearAllFilters)="this.clearAllFiltersFromActiveFilters()"
              ></app-active-filters>
            </div>
          </ng-container>
        </div>

        <!-- Results -->
        <div class="row">
          <app-search-results
            class="col px-0 ps-lg-2"
            [currentTab]="selectedTabData"
            [updateFilters]="updateFilters"
          ></app-search-results>
        </div>
      </main>
    </div>
  </div>

  <!-- Filters template -->
  <ng-template #filtersTemplate>
    <ng-container *ngFor="let item of tabChangeService.tabData">
      <app-filters
        *ngIf="tab === item.link"
        [responseData]="filterValues"
        [filterOrigin]="item.data"
        [externalFilterQuery]="tab === 'funding-calls' && externalFilterQuery"
      ></app-filters>
    </ng-container>
  </ng-template>

  <ng-template #pageOverflow>
    <div class="row main-content">
      <div class="col text-center no-results">
        <h2 i18n="@@maxResults1">Tuloksia näytetään enintään 10 000</h2>
        <p i18n="@@maxResults2">
          Jos hakemaasi tulosta ei löytynyt, yritä tarkentaa hakua.
        </p>
      </div>
    </div>
  </ng-template>

  <ng-template #visualModal>
    <div class="visual-dialog-body">
      <div class="row">
        <div class="col-3">
          <div
            #info
            *ngIf="showInfo"
            class="info p-3"
            [ngClass]="mobile ? 'right' : 'left'"
          >
            <strong class="d-block pb-2" i18n="@@additionalInfo"
              >Lisätietoa</strong
            >
            <div [innerHtml]="visualisationInfo"></div>
          </div>
          <!-- <mat-slide-toggle [(ngModel)]="fundingAmount" *ngIf="tab === 'fundings'" (change)="changeVisual($event)">Myönnetyn summan mukaan</mat-slide-toggle> -->
          <mat-form-field class="visual-select">
            <mat-label class="strong" i18n="@@chooseTheme"
              >Valitse teema</mat-label
            >
            <mat-select (selectionChange)="changeVisual($event)">
              <mat-option
                *ngFor="let category of visualisationCategories; let i = index"
                value="{{ i }}"
                >{{ category.select }}</mat-option
              >
            </mat-select>
          </mat-form-field>
          <div class="overflow-wrapper mb-2">
            <ng-container [ngTemplateOutlet]="filtersTemplate"></ng-container>
          </div>
          <app-secondary-button
            (click)="clearFilters()"
            [big]="true"
            [content]="clearActiveFilters"
            [icon]="faTrash"
          ></app-secondary-button>
        </div>
        <div class="col-9 row">
          <!-- <div *ngIf="tab === 'fundings'" class="ml-auto pb-2 col-6">
            <button
              class="col-6 vis-style-toggle ttv-button"
              [class.active]="!visualisationType"
              (click)="
              visualisationType = false
              "
              i18n="@@asBarChart">
              Pylväskuvaaja
            </button>
            <button
              class="col-6 vis-style-toggle ttv-button"
              [class.active]="visualisationType"
              (click)="
              getVisualData();
              visualisationType = true
              "
              i18n="@@asPieChart">
              Piiraskuvaaja
            </button>
          </div>   -->
          <app-active-filters
            (clearAllFilters)="this.clearAllFiltersFromActiveFilters()"
          ></app-active-filters>
          <app-visualisation
            #visualisationsRef
            [data]="visualData"
            [tab]="tab"
            [visIdx]="visIdx"
            [percentage]="percentage"
            [loading]="visualLoading"
            [searchTerm]="searchTerm"
            [searchTarget]="searchTargetName"
            [visualisationType]="visualisationType"
          ></app-visualisation>
          <div class="row vis-info">
            <div class="col">
              <div class="row">
                <div
                  *ngIf="tab === 'publications'"
                  class="vis-style-toggles row"
                >
                  <button
                    class="col vis-style-toggle ttv-button"
                    [class.active]="!percentage && !fundingAmount"
                    (click)="
                      percentage = false;
                      fundingAmount = false;
                      changeVisual($event)
                    "
                    i18n="@@asCountPublication"
                  >
                    Julkaisujen määrä
                  </button>
                  <button
                    class="col vis-style-toggle ttv-button"
                    [class.active]="percentage && !fundingAmount"
                    (click)="percentage = true; fundingAmount = false"
                    i18n="@@asPercentPublication"
                  >
                    % julkaisujen määrästä
                  </button>
                </div>
                <div *ngIf="tab === 'fundings'" class="vis-style-toggles row">
                  <button
                    class="col-6 vis-style-toggle ttv-button"
                    [class.active]="!percentage && !fundingAmount"
                    (click)="
                      changeVisual({ fundingAmount: false });
                      percentage = false;
                      fundingAmount = false
                    "
                    i18n="@@asCountFunding"
                  >
                    Hankkeiden määrä
                  </button>
                  <button
                    class="col-6 vis-style-toggle ttv-button"
                    [class.active]="percentage && !fundingAmount"
                    (click)="
                      changeVisual({ fundingAmount: false });
                      percentage = true;
                      fundingAmount = false
                    "
                    i18n="@@asPercentFunding"
                  >
                    % hankkeiden määrästä
                  </button>
                  <button
                    class="col-6 vis-style-toggle ttv-button"
                    [class.active]="!percentage && fundingAmount"
                    (click)="
                      changeVisual({ fundingAmount: true });
                      percentage = false;
                      fundingAmount = true
                    "
                    i18n="@@asCountAmount"
                  >
                    Myöntösumma
                  </button>
                  <button
                    class="col-6 vis-style-toggle ttv-button"
                    [class.active]="percentage && fundingAmount"
                    (click)="
                      changeVisual({ fundingAmount: true });
                      percentage = true;
                      fundingAmount = true
                    "
                    i18n="@@asPercentAmount"
                  >
                    % myöntösummasta
                  </button>
                  <div class="col-12"></div>
                </div>
              </div>
              <!-- <ng-template #tooltipTemplate><div [innerHtml]=visualisationInfo></div></ng-template>
                        <span [tooltip]="tooltipTemplate" triggers="focus keydown" placement="top" tabindex="-1" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                            <app-secondary-button [icon]="'info-circle'" [content]="'Info'" ></app-secondary-button>
                        </span> -->
            </div>
            <div class="col pe-0 text-end">
              <app-secondary-button
                id="download-image"
                [icon]="faDownload"
                [content]="downloadImage"
                (click)="visualisationsRef.saveAsImageClick()"
              ></app-secondary-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Reusable dialog -->
  <app-dialog
    *ngIf="showDialog"
    [template]="dialogTemplate"
    [title]="dialogTitle"
    (onActionClick)="closeDialog()"
    centerTitle
    wide
    noPadding
    position="top"
    extraClass="visual-dialog"
    [headerInfoTemplate]="dialogHeaderInfo"
  ></app-dialog>

  <ng-template #dialogHeaderInfo>
    <div
      class="d-inline-block"
      (click)="showInfo = !showInfo"
      (keydown.enter)="showInfo = !showInfo"
      tabindex="0"
      (clickOutside)="onClickedOutside($event)"
    >
      <fa-icon
        class="info-icon pe-2"
        icon="info-circle"
        (mouseenter)="showInfo = true"
      ></fa-icon>
      <a>{{ additionalInfo }} </a>
    </div>
  </ng-template>
</div>

<app-dialog
  *ngIf="showLoginInfoDialog"
  [title]="betaDialogTitle"
  [template]="myDataBetaTemplate"
  (onActionClick)="showLoginInfoDialog = false"
></app-dialog>

<ng-template #myDataBetaTemplate>
  <div class="row">
    <div class="col">
      <p *ngFor="let item of myDataInfoTexts">
        {{ item }}
      </p>
    </div>
  </div>
</ng-template>
