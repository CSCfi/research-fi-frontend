<!--  This file is part of the research.fi API service
 Copyright 2019 Ministry of Education and Culture, Finland
 :author: CSC - IT Center for Science Ltd., Espoo Finland servicedesk@csc.fi
 :license: MIT -->

<div class="bar background-primary"></div>
<h1 #srHeader class="sr-only"></h1>

<div
  class="wrapper single-funding-calls-wrap"
  *ngIf="responseData"
  id="main-content"
>
  <!-- Breadcrumb -->
  <app-breadcrumb
    [type]="'funding-call'"
    [responseData]="responseData"
    [tab]="tab"
    [tabName]="tabData.label"
    [resultNameField]="'name'"
    [queryParams]="tabQueryParams"
  ></app-breadcrumb>
  <div class="row shared">
    <p class="back col-12 mb-3">
      <a
        #backToResultsLink
        routerLink="/funding-calls/{{ searchTerm }}"
        [queryParams]="tabQueryParams"
        >&lt;
        <ng-container i18n="@@backToResults"
          >Takaisin hakutuloksiin
        </ng-container>
      </a>
    </p>
    <div
      class="col-12"
      style="margin: 10px 0 10px 0"
      *ngIf="responseData.total === 0"
    >
      <h2 i18n="@@404">404 - Virheellinen osoite</h2>
    </div>
    <main class="col-12 col-md-8">
      <div *ngFor="let call of responseData.fundingCalls">
        <div class="row d-flex justify-content-around">
          <div class="col p-0">
            <h1 class="result-header">{{ call.name }}</h1>
          </div>
        </div>

        <div id="info">
          <!-- ApplicationPeriod -->
          <div class="row content" *ngFor="let row of applicationPeriodFields">
            <!-- Labels -->
            <h2 class="col-12 col-sm-6 col-lg-3 th">
              <span class="pe-1">{{ row.label }}</span>
              <ng-container *ngIf="row.tooltip">
                <ng-template #tooltipTemplate>
                  <div [innerHtml]="row.tooltip"></div>
                </ng-template>
                <span
                  [tooltip]="tooltipTemplate"
                  tabindex="0"
                  placement="top"
                  #elem
                >
                  <fa-icon class="info-icon" icon="info-circle"></fa-icon>
                </span>
              </ng-container>
            </h2>
            <div class="col-12 col-sm-8 col-lg-9 td">
              <div [ngClass]="expand ? 'expand' : 'short'">
                <!-- Not continuous -->
                <!-- Show open date only if not 1900 -->
                <ng-container *ngIf="call.openDate.getYear()">
                  {{ call.openDateString }}
                </ng-container>
                <!-- Show dash if range -->
                <ng-container
                  *ngIf="
                    call.openDate.getYear() ||
                    call.dueDate.getFullYear() !== 2100
                  "
                >
                  -
                </ng-container>
                <!-- Show due date if not continuous -->
                <ng-container *ngIf="call.dueDate.getFullYear() !== 2100">
                  {{ call.dueDateString }}
                </ng-container>
                <!-- Continuous -->
                <ng-container
                  *ngIf="call.dueDate.getFullYear() === 2100"
                  i18n="@@continuous"
                  >Jatkuva
                </ng-container>
              </div>
            </div>
          </div>
          <!-- InfoFields -->
          <div class="row content" *ngFor="let row of infoFields">
            <!-- Labels -->
            <h2 class="col-12 col-sm-6 col-lg-3 th">
              <span class="pe-1">{{ row.label }}</span>
              <ng-container *ngIf="row.tooltip">
                <ng-template #tooltipTemplate>
                  <div [innerHtml]="row.tooltip"></div>
                </ng-template>
                <span
                  [tooltip]="tooltipTemplate"
                  tabindex="0"
                  placement="top"
                  #elem
                >
                  <fa-icon class="info-icon" icon="info-circle"></fa-icon>
                </span>
              </ng-container>
            </h2>
            <div class="col-12 col-sm-8 col-lg-9 td">
              <!-- Strip HTML tags for short preview. Makes line-clamp work on Firefox -->
              <div
                [ngClass]="
                  row.field !== 'description' || expandDescription
                    ? 'expand'
                    : 'short'
                "
                [innerHTML]="
                  call[
                    row.field +
                      (row.field !== 'description' || expandDescription
                        ? ''
                        : 'Parsed')
                  ]
                "
              >
                <!-- {{ call[row.field] }} -->
              </div>
              <a
                href="javascript:void(0)"
                class="read-more"
                *ngIf="
                  row.field === 'description' && call.description?.length > 256
                "
                (click)="expand('description')"
                [innerHTML]="expandDescription ? showLess : showMore"
              >
              </a>
            </div>
          </div>
          <!-- Categories -->
          <div class="row content" *ngFor="let row of categories">
            <!-- Labels -->
            <h2 class="col-12 col-sm-6 col-lg-3 th">
              <span class="pe-1">{{ row.label }}</span>
              <ng-container *ngIf="row.tooltip">
                <ng-template #tooltipTemplate>
                  <div [innerHtml]="row.tooltip"></div>
                </ng-template>
                <span
                  [tooltip]="tooltipTemplate"
                  tabindex="0"
                  placement="top"
                  #elem
                >
                  <fa-icon class="info-icon" icon="info-circle"></fa-icon>
                </span>
              </ng-container>
            </h2>
            <div class="col-12 col-sm-8 col-lg-9 td">
                <span *ngFor="let category of call.categories; let last = last; let i = index" class="categories-title-wrap">
                  <span *ngIf="category.isParent" class="fw-bold d-block categories-title">{{ category.name }}</span>
                  <span *ngIf="!category.isParent">{{ category.name }}<ng-container *ngIf="!last && !call?.categories[i+1].isParent">, </ng-container></span>
                </span>
            </div>
          </div>
          <!-- ApplicationInfoFields -->
          <div class="row content" *ngFor="let row of applicationInfoFields">
            <!-- Labels -->
            <h2 class="col-12 col-sm-6 col-lg-3 th">
              <span class="pe-1">{{ row.label }}</span>
              <ng-container *ngIf="row.tooltip">
                <ng-template #tooltipTemplate>
                  <div [innerHtml]="row.tooltip"></div>
                </ng-template>
                <span
                  [tooltip]="tooltipTemplate"
                  tabindex="0"
                  placement="top"
                  #elem
                >
                  <fa-icon class="info-icon" icon="info-circle"></fa-icon>
                </span>
              </ng-container>
            </h2>
            <div class="col-12 col-sm-8 col-lg-9 td">
              <!-- Strip HTML tags for short preview. Makes line-clamp work on Firefox -->
              <div
                [ngClass]="
                  row.field !== 'terms' || expandTerms ? 'expand' : 'short'
                "
                [innerHTML]="
                  call[
                    row.field +
                      (row.field !== 'terms' || expandTerms ? '' : 'short')
                  ]
                "
              >
                <!-- {{ call[row.field] }} -->
              </div>
              <a
                href="javascript:void(0)"
                class="read-more"
                *ngIf="row.field === 'terms' && call.terms?.length > 256"
                (click)="expand('terms')"
                [innerHTML]="expandTerms ? showLess : showMore"
              >
              </a>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div
      *ngFor="let call of responseData.fundingCalls"
      class="col-12 col-md-4 funding-sidebar"
    >
      <ng-container *ngFor="let row of funderFields">
        <aside>
          <mat-card>
            <div class="inner">
              <div *ngIf="call[row.field].name" class="row links mt-0 mb-4">
                <mat-card-title>
                  <h2 class="mb-0">
                    {{ call[row.field].name }}
                  </h2>
                </mat-card-title>

                <div
                  *ngIf="call[row.field].url"
                  class="col-12 px-0 link d-flex"
                >
                  <span class="link-tag">URL</span>
                  <span class="link-item"
                    ><a
                      [href]="fixExternalUrl(call[row.field].url)"
                      target="_blank"
                      ><span class="link-label">{{ call[row.field].url }}</span
                      ><fa-icon icon="external-link-alt"></fa-icon></a
                  ></span>
                </div>
                <div
                  *ngIf="call[row.field].foundationUrl"
                  class="col-12 px-0 link d-flex"
                >
                  <span class="link-tag">URL</span>
                  <span class="link-item"
                    ><a
                      [href]="fixExternalUrl(call[row.field].foundationUrl)"
                      target="_blank"
                      >{{ call[row.field].foundationUrl }}
                      <fa-icon icon="external-link-alt"></fa-icon></a
                  ></span>
                </div>
                <h2
                  *ngIf="call[row.field].applicationUrl"
                  i18n="@@fundingCallWebsite"
                  class="mt-4"
                >
                  Rahoitushaun verkkosivu
                </h2>
                <div
                  *ngIf="call[row.field].applicationUrl"
                  class="col-12 px-0 link d-flex"
                >
                  <span class="link-tag">URL</span>
                  <span class="link-item"
                    ><a
                      [href]="fixExternalUrl(call[row.field].applicationUrl)"
                      target="_blank"
                      ><span class="link-label">{{
                        call[row.field].applicationUrl
                      }}</span
                      ><fa-icon icon="external-link-alt"></fa-icon></a
                  ></span>
                </div>
                <br>
                <!-- <div *ngIf="!linksFields.length && !call.selfArchivedData" class="no-links" i18n="@@noFundingCallLinks">
                                  Rahoitushakuun ei ole tarjolla linkkejä tässä portaalissa
                              </div> -->
              </div>
              <div *ngIf="contactInfoRows?.length > 0">
                <h2>
                  {{contactInfoHeading}}
                </h2>
                <div *ngFor="let row of contactInfoRows">
                  <ng-container *ngIf="row?.field === 'emailAddress'; else nonEmail">
                    <a
                      href="javascript:void(0)"
                      (click)="showEmail($event, row?.email)"
                      i18n="@@showEmailAddress"
                    >Näytä sähköpostiosoite</a
                      >
                  </ng-container>
                    <ng-template #nonEmail>
                      <div>{{row}}</div>
                    </ng-template>
                </div>
              </div>
            </div>
          </mat-card>
        </aside>

        <!-- <aside>
         <mat-card>
           <mat-card-title>
             <h2 i18n="@@citationHeader">Viittaa</h2>
           </mat-card-title>
           <div>
             <div class="reference">
               <app-secondary-button
                 (click)="openModal(ccallodal)"
                 [content]="copyReferences"
                 [icon]="faQuoteRight"
                 [big]="true"
                 [disabled]="true"
               ></app-secondary-button>
               <small *ngIf="!hasDoi" class="no-doi-warn" i18n="@@doiWarning">Viitetiedot eivät ole saatavilla, koska julkaisulla ei ole DOI-tunnistetta.</small>
             </div>
           </div>
         </mat-card>
       </aside> -->
        <!-- Copy url -->
        <aside>
          <mat-card>
            <div class="inner">
              <mat-card-title>
                <h2 i18n="@@shareHeader">Jaa</h2>
              </mat-card-title>
              <app-share [id]="call.id"></app-share>
            </div>
          </mat-card>
        </aside>
        <!--<aside>
          <mat-card>
            <div class="inner">
              <mat-card-title>
                <h2 i18n="@@fundingCallSource">Rahoitushaun lähde</h2>
              </mat-card-title>
              <div class="links">
                <a href="https://www.aurora-tietokanta.fi/" target="_blank">
                  <ng-container i18n="@@auroraDatabase"
                    >Aurora-tietokanta
                  </ng-container>
                  <fa-icon icon="external-link-alt"></fa-icon>
                </a>
              </div>
              <div>
                          <p *ngIf="!call.dataCatalog?.length">
                              Tiedon lähde ei saatavilla.
                          </p>
                      </div>
              <div class="clear"></div>
            </div>
          </mat-card>
        </aside>-->
      </ng-container>
    </div>
  </div>
</div>
