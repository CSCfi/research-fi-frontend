<!--  This file is part of the research.fi API service
 Copyright 2019 Minisdivy of Education and Culture, Finland
 :author: CSC - IT Center for Science Ldiv., Espoo Finland servicedesk@csc.fi
 :license: MIT -->

 <h1 #srHeader class="sr-only"></h1>
 <aside>
     <app-search-bar></app-search-bar>
 </aside>
 
 <div class="wrapper" *ngIf="responseData" id="main-content">
     <!-- Breadcrumb -->
     <app-breadcrumb [type]="'single'" [responseData]="responseData" [tab]="tab" [tabName]="tabData.label" [resultNameField]="'name'" [queryParams]="tabQueryParams"></app-breadcrumb>
     <div class="row shared">
        <p class="back col-12"><a routerLink="/results/{{tab}}/{{searchTerm}}" [queryParams]="tabQueryParams">&lt; <ng-container i18n="@@backToResults">Takaisin hakutuloksiin</ng-container></a></p>
         <div class="col-12" style="margin: 10px 0 10px 0;" *ngIf="responseData.total === 0">
             <h2 i18n="@@404">404 - Virheellinen osoite</h2>
         </div>
         <main class="col-12 col-md-8">
             <div *ngFor="let item of responseData.fundings">
                 <h1 class="result-header">{{item.name}}</h1>
                 <div id="info" class="table">
                    <div class="content">
                        <ng-container *ngFor="let row of infoFields">
                            <div class="row" *ngIf="item[row.field]">
                                <h2 class="col-12 col-sm-4 col-lg-3 th">
                                    {{row.label}}
                                    <ng-container *ngIf="row.tooltip">
                                        <ng-template #tooltipTemplate><div [innerHtml]="row.tooltip"></div></ng-template>
                                        <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                            <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                                        </span>
                                    </ng-container>
                                </h2>
                                <div class="col-12 col-sm-8 col-lg-9 td">
                                    <div [ngClass]="expand ? 'expand' : 'short'">{{item[row.field]}}</div>
                                    <a href="javascript:void(0)" class="read-more" *ngIf="row.field === 'description' && item.description?.length > 256" (click)="expandDescription()" 
                                        [innerHTML]="expand ? showLess : showMore"></a>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                    <!-- Funded -->
                    <div class="content recipient">
                        <div class="row">
                            <h2 class="col-12 col-sm-4 col-lg-3 th">
                                <ng-container i18n="@@fundingRecipientHeader">Myönnetty rahoitus</ng-container>
                                <ng-template #tooltipTemplate>
                                    <div [innerHtml]="recipientTooltip.tooltip"></div>
                                </ng-template>
                                <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                    <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                                </span>
                            </h2>
                            <!-- Switch by recipien type -->
                            <div class="col-12 col-sm-8 col-lg-9 px-0" [ngSwitch]="item.recipientType">
                                <!-- Person & consortium -->
                                <div class="row" *ngSwitchDefault>
                                    <div class="col-12 col-lg-3 td pr-0 " *ngIf="item.recipient.personName?.trim().length > 0">
                                        {{item.recipient.personName}}
                                        <app-orcid *ngIf="item.recipient.personOrcid" [orcid]="item.recipient.personOrcid"></app-orcid>
                                    </div>
                                    <div class="td col-12 col-lg-4 " *ngIf="item.recipient.affiliation?.length > 0">
                                        <a *ngIf="item.recipient.organizationId" routerLink="/results/organization/{{item.recipient.organizationId}}">{{item.recipient.affiliation}}</a>
                                        <ng-container *ngIf="!item.recipient.organizationId">{{item.recipient.affiliation}}</ng-container>
                                    </div>
                                    <div class="td col-12 col-lg-3 ">
                                        {{item.recipient.shareOfFundingEur | thousandSeparator}} €
                                    </div>
                                </div>
                                <!-- Organization -->
                                <div class="row" *ngSwitchCase="'organization'">
                                    <div class="col px-0" *ngIf="item.recipient.organizations.length > 0; else noOrganizations">
                                        <div class="row" *ngFor="let org of item.recipient.organizations; let i = index;">
                                            <!-- Show contact person for non eu funding -->
                                            <!-- <div class="col-6 col-sm-3  td" *ngIf="!item.euFunding">
                                                {{item.recipient.contactPersonName}}
                                                <app-orcid *ngIf="item.recipient.personOrcid" [orcid]="item.recipient.personOrcid"></app-orcid>
                                            </div> -->
                                            <div class="col-12 td" [ngClass]="item.euFunding ? 'col-sm-5' : 'col-auto'">
                                                <a *ngIf="org.id && org.pic" routerLink="/results/organization/{{org.id}}">{{org.name}}</a>
                                                <ng-container *ngIf="org.id && !org.pic">{{org.name}}</ng-container>    
                                                <ng-container *ngIf="!org.id">{{org.name}}</ng-container>
                                                <!-- Organization country code when funder is EU -->
                                                <ng-container *ngIf="item.euFunding && org.countryCode && org.countryCode !== 'FI'"> ({{org.countryCode}})</ng-container>
                                            </div>
                                            <div class="col-12 td col-sm-3 py-0 py-sm-3" *ngIf="org.shareOfFundingEur !== item.recipient.amountEur">
                                                {{org.shareOfFundingEur | thousandSeparator}} €
                                            </div>
                                            <div class="col-12 td col-sm-3 py-0 py-sm-3 pb-3" *ngIf="item.euFunding">
                                                {{org.role}}
                                            </div>
                                        </div>
                                    </div>
                                    <ng-template #noOrganizations>
                                        <ng-container *ngIf="item.recipient.contactPersonName.trim().length > 0">
                                            <h2 class="col-12 col-sm-4 col-lg-3 th">
                                                <span i18n="@@contactPerson">Yhteyshenkilö</span>
                                            </h2>
                                            <div class="col-12 col-sm-4 col-lg-5 td">
                                                {{item.recipient.contactPersonName}}
                                                <app-orcid *ngIf="item.recipient.personOrcid" [orcid]="item.recipient.personOrcid"></app-orcid>
                                            </div>
                                        </ng-container>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                        <!-- Funding amount -->
                        <div class="row" *ngIf="item.recipient.amountEur !== item.recipient.shareOfFundingEur">
                            <h2 class="col-12 col-sm-4 col-lg-3 th">
                                <ng-container [ngSwitch]="item.recipientType">
                                    <ng-container i18n="@@amountGranted" *ngSwitchCase="'organization'">Myönnetty summa </ng-container>
                                    <ng-container i18n="@@sumGranted" *ngSwitchDefault>Summa </ng-container>
                                </ng-container>
                                <ng-template #tooltipTemplate>
                                    <div [innerHtml]="fundingAmountTooltip.tooltip"></div>
                                </ng-template>                                
                                <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                    <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                                </span>
                            </h2>
                            <div class="col px-0">
                                <div class="col-12 col-sm-4 col-lg-3  offset-0 td" [ngClass]="item.recipientType === 'organization' ? (item.euFunding ? 'offset-sm-5' : '') : 'offset-sm-7'">
                                    <div [class.bold]="item.recipientType==='organization'">{{item.recipient.amountEur | thousandSeparator}} €</div>
                                </div>
                            </div>
                        </div>
                        <!-- Contact person -->
                        <div class="row" *ngIf="item.recipient.contactPersonName?.trim().length > 0">
                            <h2 class="col-12 col-sm-4 col-lg-3 th" i18n="@@contactPerson">Yhteyshenkilö</h2>
                            <div class="col-12 col-sm-4 col-lg-5 td ">
                                {{item.recipient.contactPersonName}}
                                <app-orcid *ngIf="item.recipient.contactPersonOrcid" [orcid]="item.recipient.contactPersonOrcid"></app-orcid>
                            </div>
                        </div>
                        <!-- SA-funding additional rows -->
                        <ng-container >
                            <ng-container *ngIf="item.recipientType === 'consortium' && item.funder.name === 'Suomen Akatemia'">
                                <div class="row">
                                    <h2 class="col-12 col-sm-4 col-lg-3 th" i18n="@@academyConsortium">Rooli Suomen Akatemian konsortiossa</h2>
                                    <div class="col-12 col-sm-4 td ">
                                        {{item.academyConsortium}}
                                    </div>
                                </div>
                                <div class="row" *ngIf="item.otherConsortium.length > 0">
                                    <h2 class="col-12 col-sm-4 col-lg-3 th" i18n="@@otherConsortium">Muut osapuolet</h2>
                                    <div class="col px-0">
                                        <div class="row" *ngFor="let consortium of item.otherConsortium">
                                            <div class="col-12 col-sm-3 td">
                                                {{consortium.roleInFundingGroup}}
                                            </div>
                                            <div class="col-12 col-sm-4 td ">
                                                {{consortium['consortiumOrganizationName' + currentLocale]}}
                                                <a *ngIf="consortium.consortiumOrganizationId" routerLink="/results/funding/{{consortium.projectId}}">({{consortium.consortiumProject}})</a>
                                                <ng-container *ngIf="!consortium.consortiumOrganizationId">({{consortium.consortiumProject}})</ng-container>
                                                <ng-container *ngIf="i !== item.otherConsortium.length - 1"></ng-container>
                                            </div>
                                            <div class="col-12 col-sm-3 td  pb-3">
                                                {{consortium.shareOfFundingInEur | thousandSeparator}} €
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                    </div>
                    <!-- Funder -->
                    <div class="content" *ngIf="item.funder && funderFields.length > 0">
                        <div class="row">
                            <h2 class="col-12 col-sm-4 col-lg-3 th">
                                <ng-container i18n="@@fundingFunder">Rahoittaja</ng-container>
                                <ng-template #tooltipTemplate>
                                    <div [innerHtml]="funderTooltip.tooltip"></div>
                                </ng-template>
                                <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                    <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                                </span>
                            </h2>
                            <div class="col-12 col-sm-8 col-lg-9 td">
                                {{item.funder.name}}
                            </div>
                        </div>

                        <div class="row" *ngFor="let row of funderFields">
                            <h2 class="col-12 col-sm-4 col-lg-3 th">
                                {{row.label}}
                                <ng-container *ngIf="row.tooltip">
                                    <ng-template #tooltipTemplate><div [innerHtml]="row.tooltip"></div></ng-template>
                                    <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                        <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                                    </span>
                                </ng-container>
                            </h2>
                            <div class="col-12 col-sm-8 col-lg-9 td">{{item.funder[row.field]}}</div>
                        </div>
                    </div>
                    <!-- Other -->
                    <div class="content" *ngIf="otherFields.length > 0">
                        <h2 class="th col-12 col-sm-3" i18n="@@fundingOtherInfo">Muut tiedot</h2>
                        <div class="row" *ngFor="let row of otherFields">
                            <h2 class="col-12 col-sm-4 col-lg-3 th">
                                {{row.label}}
                                <ng-container *ngIf="row.tooltip">
                                    <ng-template #tooltipTemplate><div [innerHtml]="row.tooltip"></div></ng-template>
                                    <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                        <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                                    </span>
                                </ng-container>
                            </h2>
                            <div class="col-12 col-sm-8 col-lg-9 td">{{item[row.field]}}</div>
                        </div>
                    </div>
                </div>
             </div>
         </main>
         <div *ngFor="let item of responseData.fundings" class="col-12 col-md-4 col-xl-4">
            <aside>
                <aside>
                    <mat-card>
                        <mat-card-title><h2>
                            <ng-container i18n="@@fundingHomePage">Hankkeen verkkosivu</ng-container>
                            <ng-template #tooltipTemplate>
                                <div [innerHtml]="homepageTooltip.tooltip"></div>
                            </ng-template>
                            <span [tooltip]="tooltipTemplate" tabindex="0" triggers="focus keydown" placement="top" (mouseenter)="utilityService.tooltipMouseenter(elem)" (keydown)="utilityService.tooltipKeydown(elem, $event)" #elem>
                                <fa-icon class="info-icon pl-2" icon="info-circle"></fa-icon>
                            </span>
                        </h2></mat-card-title>
                        <div class="row links">
                            <div *ngFor="let row of linkFields" class="info-link-wrapper">
                                <div class="col link">
                                    <a class="info-link" href="{{item[row.field]}}" target="_blank">{{item[row.field]}} <fa-icon icon="external-link-alt"></fa-icon></a>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="!linkFields.length" class="no-links" i18n="@@noFundingLinks">Hankkeeseen ei ole tarjolla linkkejä tässä portaalissa</div>
                    </mat-card>
                </aside>
                <mat-card>
                    <mat-card-title><h2><ng-container i18n="@@relatedFundings">Tähän hankkeeseen liittyvät</ng-container> (<ng-container i18n="@@comingSoon">tulossa</ng-container>)</h2></mat-card-title>
                    <app-related-links [id]="" [relatedFilters]="{}"></app-related-links>
                </mat-card>
            </aside>
            <!-- <aside>
                <mat-card>
                    <mat-card-title><h2>Viittaa</h2></mat-card-title>
                    <div class="row">
                        <div class="col-12 reference">
                            <button mat-raised-button color="primary"><fa-icon [icon]="faQuoteRight" class="quote"></fa-icon>Kopioi viitetiedot...</button>
                        </div>
                    </div>
                </mat-card>
            </aside> -->
            <!-- Copy url -->
            <aside>
                <mat-card>
                    <mat-card-title><h2 i18n="@@share">Jaa</h2></mat-card-title>
                    <app-share></app-share>
                </mat-card>
            </aside>
            <aside>
                <mat-card>
                    <mat-card-title><h2 i18n="@@fundingSource">Hanketiedon lähde</h2></mat-card-title>
                    <div *ngFor="let source of responseData.fundings">
                        <p *ngIf="source.funder.name.trim().length > 0" i18n="@@fundingFunderSource">Rahoittaja: {{source.funder.name}}</p>
                        <p *ngIf="source.funder.name.trim().length === 0" i18n="@@noInformationSource">Tiedon lähde ei saatavilla.</p>
                    </div>
                    <div class="clear"></div>
                </mat-card>
            </aside>
        </div>
     </div>
 </div>