<!--  This file is part of the research.fi API service
 Copyright 2019 Ministry of Education and Culture, Finland
 :author: CSC - IT Center for Science Ltd., Espoo Finland servicedesk@csc.fi
 :license: MIT -->
    
 <div class="mobile mx-auto" id="navbar-toggle">
    <button class="navbar-toggler navbar-toggler-right container-fluid" type="button" (click)="openModal(filterModal)">
        <h3>Rajaa hakua</h3>
    </button>
</div>

<ng-template #filterModal>
    <div class="modal-header">
        <h5 class="modal-title">Rajaa hakua</h5>
    </div>
    <div class="modal-body">
        <ng-container *ngTemplateOutlet="filters"></ng-container>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn modal-close" (click)="closeModal()" (keydown)="preventTab($event)">Sulje</button>
    </div>
</ng-template>


<ng-container *ngIf="!mobile">
    <ng-container *ngTemplateOutlet="filters"></ng-container>
</ng-container>

<ng-template #filters>
    <div class="filter-sidebar" *ngFor="let response of responseData">
        <h3 *ngIf="!mobile">Rajaa hakua</h3>
        <div class="filter-wrapper">
            <mat-accordion>
                <mat-expansion-panel [expanded]="parentPanel === 'year'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()" (keydown)="preventTabBack($event)">
                        <mat-panel-title>
                            <strong>Julkaisuvuosi</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <mat-selection-list #selectedYear (selectionChange)="onSelectionChange(); parentPanel = 'year'" [class.limit]="limitList" [style.max-height.px]="height">
                        <mat-list-option checkboxPosition="before" *ngFor="let year of response.aggregations.years.buckets" 
                        [value]="year.key" [selected]="preSelection.indexOf(''+year.key) > -1">
                        <div class="row d-flex justify-content-around">
                            <div class="col-9"><span class="label">{{year.key}}</span></div>
                            <div class="col-3 count"><span class="amount" [innerHtml]="(year.doc_count | thousandSeparator)"></span></div>
                        </div>
                        </mat-list-option>
                    </mat-selection-list>
                    <button mat-button class="show-more" *ngIf="clickCount + 1 < response.aggregations.years.buckets.length / 5" 
                    (click)="showMore(response.aggregations.years.buckets.length)">Näytä lisää...</button>
                </mat-expansion-panel>

                <mat-expansion-panel (closed)="panelOpenState = -1" [expanded]="parentPanel === 'organization'" *ngIf="response.aggregations.sector?.sectorName?.buckets.length > 0">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()">
                        <mat-panel-title>
                            <strong>Organisaatio</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="subFields">
                        <div *ngFor="let sector of response.aggregations.sector?.sectorName?.buckets, let i = index">
                            <mat-expansion-panel 
                            (opened)="panelOpenState = i; parentPanel = 'organization'" [expanded]="panelOpenState === i && parentPanel === 'organization' ? true : false">
                                <mat-expansion-panel-header expandedHeight="auto" collapsedHeight="auto">
                                    <mat-panel-title>
                                        <span class="filter-title">{{sector.key}}</span>
                                        <mat-checkbox [checked]="sector.organizations.buckets.length === selectedOrganizations.selectedOptions.selected.length" (click)="$event.stopPropagation()" 
                                        (change)="panelOpenState = -1; parentPanel = 'organization'" (change)="selectAll($event, i, 'sector')" style="padding:0 10px;"></mat-checkbox>
                                    </mat-panel-title>
                                </mat-expansion-panel-header>
                                <mat-selection-list #selectedOrganizations (selectionChange)="onSelectionChange()">
                                    <mat-list-option checkboxPosition="before" *ngFor="let organization of sector.organizations.buckets" 
                                    [value]="organization.orgId.buckets[0].key" [selected]="preSelection.indexOf(organization.orgId.buckets[0].key) > -1">
                                        <div class="row d-flex justify-content-around">
                                            <div class="col-9"><span class="label">{{organization.key.trim()}}</span></div>
                                            <div class="col-3 count"><span class="amount" [innerHtml]="(organization.doc_count | thousandSeparator)"></span></div>
                                        </div>
                                    </mat-list-option>
                                </mat-selection-list>
                            </mat-expansion-panel>
                        </div>
                    </div>
                </mat-expansion-panel>

                <mat-expansion-panel (closed)="panelOpenState = -1" [expanded]="parentPanel === 'major'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()">
                        <mat-panel-title>
                            <strong>Tieteenala</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="subFields">
                        <div *ngFor="let major of staticDataService.majorFieldsOfScience, let i = index">
                            <mat-expansion-panel *ngIf="combinedMajorFields[i] && combinedMajorFields[i].length > 0" 
                                (opened)="panelOpenState = i; parentPanel = 'major'" [expanded]="panelOpenState === i && parentPanel === 'major' ? true : false">
                                <mat-expansion-panel-header expandedHeight="auto" collapsedHeight="auto">
                                    <mat-panel-title>
                                        <span class="filter-title">{{major.label}}</span>
                                        <mat-checkbox [checked]="major.checked" (change)="panelOpenState = -1; parentPanel = 'major'" (click)="$event.stopPropagation()" 
                                        (change)="selectAll($event, i, 'field')" style="padding:0 10px;"></mat-checkbox>
                                    </mat-panel-title>
                                </mat-expansion-panel-header>
                                <!-- <mat-form-field>
                                    <input matInput placeholder="Rajaa tieteenaloja" autocomplete="off" (keyup)="filterInput($event)">
                                </mat-form-field> -->
                                <mat-selection-list #selectedFields (selectionChange)="onSelectionChange()">
                                    <mat-list-option checkboxPosition="before" *ngFor="let field of combinedMajorFields[i]" 
                                    [value]="field.field" [selected]="preSelection.indexOf(field.field) > -1">
                                        <div class="row d-flex justify-content-around">
                                            <div class="col-9"><span class="label">{{field.field}}</span></div>
                                            <div class="col-3 count"><span class="amount" [innerHtml]="(field.doc_count | thousandSeparator)"></span></div>
                                        </div>
                                    </mat-list-option>
                                </mat-selection-list>
                            </mat-expansion-panel>
                        </div>
                    </div>
                </mat-expansion-panel>

                <mat-expansion-panel (closed)="panelOpenState = -1" [expanded]="parentPanel === 'type'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()">
                        <mat-panel-title>
                            <strong>Julkaisutyyppi</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="subFields">
                        <div *ngFor="let class of staticDataService.publicationClass">
                            <div *ngFor="let classType of filteredPublicationClass, let i = index">
                                <mat-expansion-panel *ngIf="class.class === classType"
                                (opened)="panelOpenState = i; parentPanel = 'type'" [expanded]="panelOpenState === i && parentPanel === 'type' ? true : false">
                                    <mat-expansion-panel-header expandedHeight="auto" collapsedHeight="auto">
                                        <mat-panel-title>
                                            <span class="filter-title">{{class.class}} {{class.label}}</span>
                                            <mat-checkbox [checked]="class.checked" (change)="panelOpenState = -1; parentPanel = 'type'" (click)="$event.stopPropagation()" 
                                            (change)="selectAll($event, i, 'type')" style="padding:0 10px;"></mat-checkbox>
                                        </mat-panel-title>
                                    </mat-expansion-panel-header>
                                    <mat-selection-list #selectedPublicationTypes (selectionChange)="onSelectionChange()">
                                        <div *ngFor="let item of response.aggregations.publicationType.buckets">
                                            <div *ngFor="let type of class.types">
                                                <mat-list-option checkboxPosition="before" *ngIf="type.type === item.key"  
                                                [value]="type.type" [selected]="preSelection.indexOf(type.type) > -1">
                                                    <div class="row d-flex justify-content-around">
                                                        <div class="col-9"><span class="label">{{type.type}}, {{type.label}}</span></div>
                                                        <div class="col-3 count"><span class="amount" [innerHtml]="(item.doc_count | thousandSeparator)"></span></div>
                                                    </div>
                                                </mat-list-option>
                                            </div>
                                        </div>
                                    </mat-selection-list>
                                </mat-expansion-panel>
                            </div>
                        </div>
                    </div>
                </mat-expansion-panel>

                <mat-expansion-panel [expanded]="parentPanel === 'country'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()">
                        <mat-panel-title>
                            <strong>Julkaisumaa</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <mat-selection-list #selectedCountryCode (selectionChange)="onSelectionChange(); parentPanel = 'country'" [class.limit]="limitList" [style.max-height.px]="height">
                        <mat-list-option checkboxPosition="before" *ngFor="let code of response.aggregations.countryCode.buckets"
                        [value]="'c' + code.key" [selected]="preSelection.indexOf(''+ 'c' + code.key) > -1">
                            <div class="row d-flex justify-content-around">
                                <div class="col-9">
                                    <span [innerHtml]="code.key === 0 ? 'Suomi' : 'Muu'" class="label"></span>
                                </div>
                                <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                            </div>
                        </mat-list-option>
                    </mat-selection-list>
                    <button mat-button class="show-more" *ngIf="clickCount + 1 < response.aggregations.countryCode.buckets.length / 5" 
                    (click)="showMore(response.aggregations.years.buckets.length)">Näytä lisää...</button>
                </mat-expansion-panel>
    
                <mat-expansion-panel [expanded]="parentPanel === 'lang'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()">
                        <mat-panel-title>
                            <strong>Kieli</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <mat-selection-list #selectedLang (selectionChange)="onSelectionChange(); parentPanel = 'lang'" [class.limit]="limitList" [style.max-height.px]="height">
                        <div *ngFor="let code of response.aggregations.languageCode.buckets">
                            <mat-list-option checkboxPosition="before" *ngIf="code.language.buckets[0].key !== 'undefined'"
                            [value]="code.key" [selected]="preSelection.indexOf(''+code.key) > -1">
                                <div class="row d-flex justify-content-around">
                                    <div class="col-9"><span class="label">{{code.language.buckets[0].key}}</span></div>
                                    <div class="col-3 count"><span class="amount" [innerHtml]="(code.language.buckets[0].doc_count | thousandSeparator)"></span></div>
                                </div>
                            </mat-list-option>
                        </div>
                    </mat-selection-list>
                    <button mat-button class="show-more" *ngIf="clickCount + 1 < response.aggregations.languageCode.buckets.length / 5" 
                    (click)="showMore(response.aggregations.languageCode.buckets.length)">Näytä lisää...</button>
                </mat-expansion-panel>

                <mat-expansion-panel [expanded]="parentPanel === 'juFo'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}" (click)="resetHeight()">
                        <mat-panel-title>
                            <strong>Julkaisufoorumitaso</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <mat-selection-list #selectedJuFo (selectionChange)="onSelectionChange(); parentPanel = 'juFo'">
                        <div *ngFor="let code of response.aggregations.juFo.buckets">
                            <mat-list-option *ngIf="code.key === '3'" checkboxPosition="before" [value]="'j3'" [selected]="preSelection.indexOf('' + 'j' + code.key) > -1">
                                <div class="row d-flex justify-content-around">
                                    <div class="col-9"><span class="label">{{code.key}} - Korkein taso</span></div>
                                    <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                                </div>
                            </mat-list-option>
                            <mat-list-option *ngIf="code.key === '2'" checkboxPosition="before" [value]="'j2'" [selected]="preSelection.indexOf('' + 'j' + code.key) > -1">
                                <div class="row d-flex justify-content-around">
                                    <div class="col-9"><span class="label">{{code.key}} - Johtava taso</span></div>
                                    <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                                </div>
                            </mat-list-option>
                            <mat-list-option *ngIf="code.key === '1'" checkboxPosition="before" [value]="'j1'" [selected]="preSelection.indexOf('' + 'j' + code.key) > -1">
                                <div class="row d-flex justify-content-around">
                                    <div class="col-9"><span class="label">{{code.key}} - Perustaso</span></div>
                                    <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                                </div>
                            </mat-list-option>
                            <mat-list-option *ngIf="code.key === '0'" checkboxPosition="before" [value]="'j0'" [selected]="preSelection.indexOf('' + 'j' + code.key) > -1">
                                <div class="row d-flex justify-content-around">
                                    <div class="col-9"><span class="label">{{code.key}} - Muut</span></div>
                                    <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                                </div>
                            </mat-list-option>
                            <mat-list-option *ngIf="code.key === ' '" checkboxPosition="before" [value]="'noVal'" [selected]="preSelection.indexOf(''+'noVal') > -1">
                                <div class="row d-flex justify-content-around">
                                    <div class="col-9"><span class="label">Ei arviota</span></div>
                                    <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                                </div>
                            </mat-list-option>
                        </div>
                    </mat-selection-list>
                </mat-expansion-panel>

                <mat-expansion-panel [expanded]="parentPanel === 'oa'">
                    <mat-expansion-panel-header expandedHeight="{{panelHeight}}" collapsedHeight="{{panelHeight}}">
                        <mat-panel-title>
                            <strong>Avoin saatavuus</strong>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <mat-selection-list #selectedOpenAccess (selectionChange)="onSelectionChange(); parentPanel = 'oa'">
                        <mat-list-option checkboxPosition="before" *ngFor="let code of openAccessCodes"
                        [value]="code.value" [selected]="preSelection.indexOf(''+code.value) > -1">
                            <div class="row d-flex justify-content-around">
                                <div class="col-9"><span class="label">{{code.label}}</span></div>
                                <div class="col-3 count"><span class="amount" [innerHtml]="(code.doc_count | thousandSeparator)"></span></div>
                            </div>
                        </mat-list-option>
                    </mat-selection-list>
                </mat-expansion-panel>
            </mat-accordion>

            <div class="single-checkbox" *ngIf="response.aggregations.internationalCollaboration?.length > 0 ">
                <div class="row single">
                    <div class="col col-10">
                        <mat-checkbox labelPosition="after" [checked]="internationalCollab" (change)="singleSelect($event)">
                            <span class="label">Kansainvälinen yhteisjulkaisu</span>
                        </mat-checkbox>
                    </div>
                    <div class="col col-1">
                        <span class="amount">{{response.aggregations.internationalCollaboration[0]?.doc_count}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>
