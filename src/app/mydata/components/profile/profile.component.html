<!--  This file is part of the research.fi API service
 Copyright 2019 Ministry of Education and Culture, Finland
 :author: CSC - IT Center for Science Ltd., Espoo Finland servicedesk@csc.fi
 :license: MIT -->

<app-banner-divider></app-banner-divider>
<main id="main-content">
  <div class="wrapper">
    <div class="row d-flex justify-content-between pt-3 pb-5">
      <div class="col-12 col-md-6 px-0">
        <div
          class="row d-flex"
          *ngIf="profileService.currentProfileName | async"
        >
          <h1 class="col-12 px-0" data-testid="profile-name">
            {{ profileService.currentProfileName | async }}
          </h1>
          <div class="col align-self-center px-0">
            <img
              class="orcid-icon mt-n1 pr-2"
              src="assets/img/orcid_icon.svg"
              alt="Orcid -palvelun logo"
            />
            <span>{{ orcidData.orcid }}</span>
          </div>
        </div>
      </div>

      <div class="col-5 d-none d-md-block px-lg-0">
        <div class="row justify-content-end align-items-center">
          <div class="col-auto profile-image-container opacity-3">
            <i class="fas fa-user text-center d-block h1"></i>
          </div>
          <a disabled class="disabled"
            >+
            <ng-container i18n="@@addPublicProfilePicture"
              >Lisää Julkinen profiilikuva</ng-container
            ></a
          >
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12 col-md-6 px-0 align-self-end">
        <h2 class="h4 d-inline-block" i18n="@@publicProfile">
          Julkinen profiili
        </h2>
        <span
          class="d-inline-block pl-0 pl-lg-3 h6 font-italic"
          *ngIf="
            (publicationsService.currentPublicationPayload | async).length ||
            (datasetsService.currentDatasetPayload | async).length ||
            (fundingsService.currentFundingPayload | async).length ||
            (patchService.currentPatchItems | async).length ||
            (collaborationsService.currentCollaborationsPayload | async).length
          "
        >
          - <ng-container i18n="@@draft">Luonnos</ng-container></span
        >
      </div>

      <!-- Handle draft publish -->
      <ng-template #publishUpdatedProfileTemplate>
        <p>
          <ng-container i18n="@@updatedProfilePublishedAt"
            >Päivitetty tutkijaprofiilisi julkaistaan kohteessa
            tiedejatutkimus.fi</ng-container
          >
          <br />
          <ng-container i18n="@@updatingPublicDataTakesFewMinutes"
            >Julkisten tietojen päivittäminen kestää muutaman
            minuutin.</ng-container
          >
        </p>
      </ng-template>

      <ng-template #dataToPublishTemplate>
        <app-draft-summary
          *ngIf="profileData"
          [profileData]="profileData"
        ></app-draft-summary>
      </ng-template>

      <div
        class="col px-0 py-2 text-right"
        *ngIf="
          (publicationsService.currentPublicationPayload | async).length ||
          (datasetsService.currentDatasetPayload | async).length ||
          (fundingsService.currentFundingPayload | async).length ||
          (patchService.currentPatchItems | async).length ||
          (collaborationsService.currentCollaborationsPayload | async).length
        "
      >
        <app-primary-action-button
          class="col-auto"
          i18n-content="@@publishEllipsis"
          content="Julkaise..."
          (click)="
            openDialog({
              title: publishUpdatedProfile,
              template: publishUpdatedProfileTemplate,
              extraContentTemplate: dataToPublishTemplate,
              actions: publishUpdatedProfileDialogActions
            })
          "
        ></app-primary-action-button>

        <!-- Discard draft -->
        <button
          mat-button
          color="primary"
          class="col-auto pr-lg-0"
          (click)="
            openDialog({
              title: discardChanges,
              template: discardChangesTemplate,
              actions: discardChangesActions
            })
          "
          i18n="@@discardChanges"
        >
          Hylkää muutokset...
        </button>

        <ng-template #discardChangesTemplate>
          <p i18n="@@discardSessionChanges">
            Hylätäänkö julkaisemattomat muutokset?
          </p>
        </ng-template>
      </div>
    </div>

    <!-- Divider -->
    <app-banner-divider
      heightInRem=".25"
      class="opacity-3"
    ></app-banner-divider>

    <!-- Groups -->
    <div class="row justify-content-between">
      <div class="col-12 col-lg-7 px-0">
        <app-profile-summary
          *ngIf="profileData; else loadingTemplate"
          class="d-block pt-3"
          [profileData]="profileData"
        ></app-profile-summary>

        <ng-template #loadingTemplate>
          <mat-spinner class="mx-auto" [diameter]="80"> </mat-spinner>
        </ng-template>
      </div>

      <div class="col-12 col-lg-5 px-0 px-lg-3">
        <!-- DEBUGGING -->
        <ng-container *ngIf="appSettingsService.myDataSettings.debug">
          <button (click)="reset()" mat-raised-button>Reset</button>
          <div class="row">
            currentPublicationPayload:
            {{ (publicationsService.currentPublicationPayload | async).length }}
          </div>
          <div class="row">
            currentDatasetPayload:
            {{ (datasetsService.currentDatasetPayload | async).length }}
          </div>
          <div class="row">
            currentFundingPayload:
            {{ (fundingsService.currentFundingPayload | async).length }}
          </div>
          <div class="row">
            currentPatchItems:
            {{ (patchService.currentPatchItems | async).length }}
          </div>
          <div class="row">
            currentCollaborationsPayload:
            {{
              (collaborationsService.currentCollaborationsPayload | async)
                .length
            }}
          </div>
        </ng-container>

        <!-- Contact card -->
        <aside *ngIf="profileData" class="profile-card">
          <app-contact-card
            i18n-label="@@contactInfo"
            label="Yhteystiedot"
            [data]="profileData"
          ></app-contact-card>
        </aside>

        <!-- Collaboration -->
        <aside class="profile-card">
          <app-collaboration-card
            #collaborationComponentRef
            i18n-label="@@cooperation"
            label="Yhteistyö"
          ></app-collaboration-card>
        </aside>

        <!-- Beta info -->
        <div class="row py-3 d-flex justify-content-center">
          <div class="col px-0">
            <app-mydata-beta-info></app-mydata-beta-info>
          </div>
        </div>

        <!-- EULA -->
        <div class="row pb-3 d-flex justify-content-center">
          <div class="col-12 px-0">
            <button
              class="row border border-primary rounded btn d-flex w-100"
              (click)="
                openDialog({
                  title: termsForTool,
                  template: termsTemplate,
                  actions: basicDialogActions
                })
              "
            >
              <div class="col-auto">
                <i class="pt-3 pb-2 h1 primary-color fas fa-file-alt"></i>
              </div>
              <div class="col align-self-center">
                <span
                  class="d-block align-self-center text-left"
                  i18n="@@openTermsOfUse"
                  >Avaa käyttöehdot</span
                >
              </div>
            </button>
          </div>
        </div>

        <div class="row d-flex justify-content-center">
          <div class="col-12 px-0">
            <button
              class="row border border-primary rounded btn d-flex w-100"
              (click)="
                openDialog({
                  title: processingOfPersonalData,
                  template: personalDataHandlingTermsTemplate,
                  actions: basicDialogActions
                })
              "
            >
              <div class="col-auto">
                <i class="pt-3 pb-2 h1 primary-color fas fa-file-alt"></i>
              </div>
              <div class="col align-self-center">
                <span
                  class="d-block align-self-center text-left"
                  i18n="@@openPersonalDataProcessingPrinciples"
                  >Avaa henkilötietojen käsittelyperiaatteet</span
                >
              </div>
            </button>
          </div>
        </div>

        <ng-template #personalDataHandlingTermsTemplate>
          <app-eula template="personalDataHandlingTermsTemplate"></app-eula>
        </ng-template>

        <ng-template #termsTemplate>
          <app-eula template="termsTemplate"></app-eula>
        </ng-template>

        <app-dialog
          *ngIf="showDialog"
          [template]="dialogTemplate"
          [title]="dialogTitle"
          [extraContentTemplate]="dialogExtraContentTemplate"
          (onActionClick)="doDialogAction($event)"
          [actions]="currentDialogActions"
        ></app-dialog>

        <!-- Delete profile -->
        <div class="row">
          <div class="col px-0 text-center text-md-left">
            <app-primary-action-button
              class="d-block pt-5 pb-4"
              (click)="
                openDialog({
                  title: deleteProfileTitle,
                  template: deleteProfileTemplate,
                  actions: deleteProfileDialogActions,
                  disableDialogClose: true
                })
              "
              i18n-content="@@deleteProfile"
              content="Poista profiili"
            ></app-primary-action-button>

            <ng-template #deleteProfileTemplate>
              <p i18n="@@thisActionDeletesTestProfile">
                Tämä toiminto poistaa Tutkijan tiedot -testisovelluksen
                profiilin.
              </p>
            </ng-template>

            <ng-template #deletingProfileTemplate>
              <div
                class="row d-flex justify-content-center"
                *ngIf="loading && !connProblem"
              >
                <div class="col-auto align-self-center">
                  <mat-spinner
                    class="mx-auto"
                    [diameter]="80"
                    i18n-aria-label="@@loading"
                    aria-label="Ladataan"
                  ></mat-spinner>
                  <span
                    class="d-block col pt-3 text-center"
                    i18n="@@deletingProfileWait"
                    aria-live="polite"
                    >Profiilia poistetaan, odota hetki...</span
                  >
                </div>
              </div>

              <div *ngIf="connProblem">
                <div class="row">
                  <div class="col mx-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <ng-container i18n="@@deleteProfileConnProblem"
                      >Yhteysongelma. Profiilin poisto ei onnistu. Kokeile
                      hetken kuluttua uudestaan.</ng-container
                    >
                  </div>
                </div>
                <div class="row py-3">
                  <div class="col text-center">
                    <app-primary-action-button
                      i18n-content="@@close"
                      content="Sulje"
                      (click)="closeDialog()"
                    ></app-primary-action-button>
                  </div>
                </div>
              </div>
            </ng-template>

            <!-- Dialog for delete profile loading indicator-->
            <app-dialog
              *ngIf="deletingProfile"
              [template]="deletingProfileTemplate"
              [small]="true"
              [disableClose]="disableDialogClose"
            ></app-dialog>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
