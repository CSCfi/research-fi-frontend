# This file is part of the research.fi API service
#
# Copyright 2019 Ministry of Education and Culture, Finland
#
# :author: CSC - IT Center for Science Ltd., Espoo Finland servicedesk@csc.fi
# :license: MIT
worker_processes auto;

error_log  /var/log/nginx/error.log warn;
pid        /tmp/nginx.pid;

events {
    worker_connections  1024;
}

http {
    # Include config file, which defines the upstream "apiserver".
    # Config file is inserted into container by OpenShift deployment config.
    include    apiconf/api.conf;

    proxy_connect_timeout 1h;
    proxy_send_timeout 1h;
    proxy_read_timeout 1h;
    tcp_nodelay on;
    tcp_nopush on;
    keepalive_timeout 15;

    server {
        listen       8080;
        server_name  researchfi-api-nginx.rahtiapp.fi;

        proxy_buffering off;
        proxy_http_version 1.1;

        # Portal API
        # Path must contain "_search"
        location ~ /portalapi/.+/_search$ {
            # Allowed methods
            limit_except GET POST OPTIONS {
                deny all;     
            }

            # Remove "portalapi" from path
            rewrite ^/portalapi(.*)$ $1 break;

            proxy_pass https://apiserver;
        }

        # Application performance monitoring
        location /apm/ {
            # Allowed methods
            limit_except GET POST OPTIONS {
                deny all;     
            }
            proxy_pass https://apiserver/apm/;
        }
    }
}